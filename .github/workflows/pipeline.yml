name: Pipeline
on: [push]

jobs:
  # test:
  #   name: "Test"
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v2
  #     - uses: actions/setup-node@v2
  #       with:
  #         node-version: '14'
  #     - name: Test backend
  #       run: |
  #         cd $GITHUB_WORKSPACE
  #         npm i
  #         npm run test
  #     - name: Test frontend
  #       run: |
  #         cd $GITHUB_WORKSPACE/frontend
  #         echo "No frontend tests yet"
  build:
    name: "Build"
    # needs: test
    # if: contains(github.ref, 'master') || contains(github.ref, 'ci')
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v2

      - name: Log in to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract tags/labels for backend
        id: meta
        uses: docker/metadata-action@v3
        with:
          images: jmanche/mern-backend

      - name: Extract short sha
        run: echo "SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Build and push Docker image
        uses: docker/build-push-action@v2
        with:
          context: .
          push: true
          tags: |
            $SHA
            latest
          labels: ${{ steps.meta.outputs.labels }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v2
        with:
          context: ./frontend
          push: true
          tags: |
            $SHA
            latest
          labels: ${{ steps.meta.outputs.labels }}
  deploy:
    name: "Deploy"
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Get latest image
        run: echo "Hey there"
